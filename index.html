<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Self Transfer</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{font-family:Arial;background:#f5f5f5;padding:20px}
form{position:relative;background:#fff;padding:20px;border-radius:10px;max-width:430px;margin:auto;box-shadow:0 0 10px rgba(0,0,0,.1)}
label{font-weight:bold;margin-top:12px;display:block}
input,select,textarea,button{
  width:100%;height:42px;padding:8px 10px;margin-top:5px;
  border-radius:6px;border:1px solid #ccc;box-sizing:border-box
}
textarea{resize:none}
button{background:#007bff;color:#fff;border:none;margin-top:15px;cursor:pointer}
.amount-cash{background:#f0f0f0!important}

/* Cash */
#denominations{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
.denom-card{border:1px solid #ccc;border-radius:10px;padding:10px;text-align:center;font-weight:bold}

/* Modal */
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);align-items:center;justify-content:center;z-index:999}
.modal-box{background:#fff;width:92%;max-width:420px;border-radius:12px;padding:16px}
.modal-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:10px}
.modal-card{border:1px solid #ccc;border-radius:8px;padding:6px;text-align:center}
.modal-actions{display:flex;gap:12px;margin-top:16px}
.cancel{background:#ccc;color:#000}
.confirm{background:#007bff;color:#fff}
</style>
</head>

<body>

<form id="transferForm">

<h2 style="text-align:center">Self Transfer</h2>

<label>Date</label>
<input type="date" id="date">

<label>Narration</label>
<textarea id="narration"></textarea>

<hr>

<h3>From</h3>
<select id="from_trtype">
  <option value="">Select</option>
  <option value="cash">Cash</option>
  <option value="UPI">UPI</option>
  <option value="NET">NET</option>
  <option value="DEBIT">DEBIT</option>
  <option value="CREDIT">CREDIT</option>
</select>

<select id="from_account" style="display:none"></select>

<hr>

<h3>To</h3>
<select id="to_trtype">
  <option value="">Select</option>
  <option value="cash">Cash</option>
  <option value="UPI">UPI</option>
  <option value="NET">NET</option>
  <option value="DEBIT">DEBIT</option>
  <option value="CREDIT">CREDIT</option>
</select>

<select id="to_account" style="display:none"></select>

<hr>

<div id="denominationsBox" style="display:none">
  <h3>Cash Denominations</h3>
  <div id="denominations"></div>
</div>

<label>Amount</label>
<input type="number" id="amount">

<button type="submit">Transfer</button>
</form>

<!-- CONFIRM MODAL -->
<div class="modal" id="confirmModal">
  <div class="modal-box">
    <h3>Confirm Transfer</h3>
    <div id="confirmText"></div>
    <div id="confirmDenoms"></div>
    <div class="modal-actions">
      <button class="cancel" onclick="closeModal()">Cancel</button>
      <button class="confirm" onclick="finalSubmit()">Confirm</button>
    </div>
  </div>
</div>

<script>
const WEBHOOK_URL="https://hook.eu1.make.com/uayw6m2h1u56gz1fuhnyewvh860q8tjy";

const bankAccounts=["FI","HDFC Old","HDFC New","ICICI","IndusInd","Kotak","RBL","SBI"];
const creditCards = [
  "Axis Flipkart","Axis MyZone","Axis Neo",
  "HDFC PhonePe","HDFC Tata Neu","HDFC Millennia",
  "HSBC","IDFC First Millenia",
  "ICICI Amazon","ICICI Coral","ICICI Expressions",
  "Indusind Plat Aura EDGE","Indusind Legend",
  "Yes Finbooster","Kotak League","Kotak Image",
  "SBI BPCL","Standard Chartered"
];const denoms=[500,200,100,50,20,10,5,2,1];

const amount=document.getElementById("amount");
const denominations=document.getElementById("denominations");

denoms.forEach(d=>{
  denominations.innerHTML+=`
    <div class="denom-card">
      ₹${d}<br>
      <input type="number" data-d="${d}" value="0" min="0">
    </div>`;
});

function buildAccount(tr, acc){
  if(!tr.value || tr.value==="cash"){
    acc.style.display="none";
    acc.innerHTML="";
    return;
  }
  const list=["UPI","NET","DEBIT"].includes(tr.value)?bankAccounts:creditCards;
  acc.innerHTML="<option value=''>Select</option>";
  list.forEach(v=>acc.innerHTML+=`<option>${v}</option>`);
  acc.style.display="block";
}

function toggleCash(){
  const isCash = from_trtype.value==="cash" || to_trtype.value==="cash";
  denominationsBox.style.display=isCash?"block":"none";
  amount.readOnly=isCash;
  amount.classList.toggle("amount-cash",isCash);

  if(!isCash){
    amount.value="";
    document.querySelectorAll("[data-d]").forEach(i=>i.value=0);
  }
}

document.addEventListener("input",e=>{
  if(e.target.dataset?.d){
    let total=0;
    document.querySelectorAll("[data-d]").forEach(i=>{
      total+=Number(i.dataset.d)*Number(i.value||0);
    });
    amount.value=total;
  }
});

from_trtype.onchange=()=>{buildAccount(from_trtype,from_account);toggleCash();}
to_trtype.onchange=()=>{buildAccount(to_trtype,to_account);toggleCash();}

transferForm.onsubmit=e=>{
  e.preventDefault();

  if(from_trtype.value==="cash" && to_trtype.value==="cash"){
    alert("Cash to Cash transfer is not allowed");
    return;
  }

  const missing=[];
  if(!date.value) missing.push("Date");
  if(!narration.value) missing.push("Narration");
  if(!from_trtype.value) missing.push("From transaction type");
  if(!to_trtype.value) missing.push("To transaction type");
  if(from_trtype.value!=="cash" && !from_account.value) missing.push("From account");
  if(to_trtype.value!=="cash" && !to_account.value) missing.push("To account");
  if(!amount.value || Number(amount.value)<=0) missing.push("Amount");

  if(missing.length){
    alert("Please fill:\n\n• "+missing.join("\n• "));
    return;
  }

  confirmText.innerHTML=`
    <p><b>Date:</b> ${date.value}</p>
    <p><b>Narration:</b> ${narration.value}</p>
    <p><b>From:</b> ${from_trtype.value==="cash"?"Cash":from_account.value}</p>
    <p><b>To:</b> ${to_trtype.value==="cash"?"Cash":to_account.value}</p>
    <p><b>Amount:</b> ₹${amount.value}</p>
  `;

  confirmDenoms.innerHTML="";
  if(from_trtype.value==="cash" || to_trtype.value==="cash"){
    confirmDenoms.innerHTML='<h4>Cash Denominations</h4><div class="modal-grid"></div>';
    const g=confirmDenoms.querySelector(".modal-grid");
    denoms.forEach(d=>{
      g.innerHTML+=`<div class="modal-card">₹${d}<br>${
        document.querySelector(`[data-d="${d}"]`).value
      }</div>`;
    });
  }

  confirmModal.style.display="flex";
};

function closeModal(){
  confirmModal.style.display="none";
}

function finalSubmit(){
  const denData={};
  document.querySelectorAll("[data-d]").forEach(i=>{
    denData[i.dataset.d]=Number(i.value)||0;
  });

  let signedAmount=Number(amount.value);
  if(from_trtype.value!=="cash" && to_trtype.value==="cash"){
    signedAmount*=-1;
  }

  fetch(WEBHOOK_URL,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      category:"self_transfer",
      date:date.value,
      narration:narration.value,
      from_transaction_type:from_trtype.value,
      from_account:from_trtype.value==="cash"?"Cash":from_account.value,
      to_transaction_type:to_trtype.value,
      to_account:to_trtype.value==="cash"?"Cash":to_account.value,
      amount:signedAmount,
      denominations:denData
    })
  });

  closeModal();
  alert("Transfer recorded");
  transferForm.reset();
  denominationsBox.style.display="none";
  amount.classList.remove("amount-cash");
}
</script>

</body>
</html>
